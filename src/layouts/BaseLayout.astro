---
import { ViewTransitions } from 'astro:transitions';
import '../styles/global.css';

interface Props {
  title: string;
  description?: string;
}

const { title, description = "Krasimir Kralev — Web Developer & QA Specialist" } = Astro.props;
const ogImage = "/images/og-image.png";
const siteUrl = "https://krasimirkralev.com";
---

<!doctype html>
<html lang="en" data-lang="en" translate="no">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <meta name="google" content="notranslate" />
    <title>{title}</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

    <!-- Theme color for mobile browsers -->
    <meta name="theme-color" content="#0c0c1d" media="(prefers-color-scheme: dark)" />
    <meta name="theme-color" content="#faf8f5" media="(prefers-color-scheme: light)" />

    <!-- Canonical -->
    <link rel="canonical" href={siteUrl} />

    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={siteUrl} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={`${siteUrl}${ogImage}`} />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={`${siteUrl}${ogImage}`} />

    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "Person",
      "name": "Krasimir Kralev",
      "url": siteUrl,
      "jobTitle": "QA & Development Specialist",
      "worksFor": { "@type": "Organization", "name": "ResultsCX" },
      "alumniOf": { "@type": "CollegeOrUniversity", "name": "University of Plovdiv" },
      "sameAs": [
        "https://github.com/SpitOnYourFace",
        "https://www.facebook.com/share/1Cyiz9qXq4/",
        "https://www.youtube.com/channel/UCtA80N1APoWs2ELq8udQHpA"
      ]
    })} />

    <!-- Fonts: preload critical + async load full set -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      rel="preload"
      as="style"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <noscript>
      <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap"
        rel="stylesheet"
      />
    </noscript>

    <!-- Theme + Language detection — runs before body to prevent flash -->
    <script is:inline>
      function __applyLang() {
        var lang = localStorage.getItem('lang');
        if (!lang) {
          var browserLang = navigator.language || navigator.userLanguage;
          lang = (browserLang && browserLang.toLowerCase().startsWith('bg')) ? 'bg' : 'en';
          localStorage.setItem('lang', lang);
        }
        document.documentElement.lang = lang;
        document.documentElement.dataset.lang = lang;
      }

      function __applyTheme() {
        var theme = localStorage.getItem('theme');
        if (!theme) {
          // Default based on Bulgaria time (Europe/Sofia): dark 19:00-07:00
          var h = new Date(new Date().toLocaleString('en-US', { timeZone: 'Europe/Sofia' })).getHours();
          theme = (h >= 19 || h < 7) ? 'dark' : 'light';
        }
        document.documentElement.classList.toggle('dark', theme === 'dark');
      }

      // Run immediately (before body paints)
      __applyLang();
      __applyTheme();

      // Re-apply after ViewTransitions swaps the document
      document.addEventListener('astro:after-swap', function() { __applyLang(); __applyTheme(); });
      // Also re-apply on every page load (initial + navigations)
      document.addEventListener('astro:page-load', function() { __applyTheme(); });
    </script>

    <style is:global>
      html[data-lang="en"] [data-lang="bg"] { display: none !important; }
      html[data-lang="bg"] [data-lang="en"] { display: none !important; }

      /* Animatable custom property for diagonal sweep position */
      @property --wipe-pos {
        syntax: '<percentage>';
        initial-value: 0%;
        inherits: false;
      }

      /* Theme sweep — angled diagonal wipe */
      #theme-sweep {
        position: fixed;
        inset: 0;
        z-index: 40;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s ease-out;
      }
      #theme-sweep.sweep-to-dark,
      #theme-sweep.sweep-to-light {
        opacity: 1;
        transition: none;
      }
      #theme-sweep.sweep-to-dark {
        background: linear-gradient(
          105deg,
          rgba(10, 12, 35, 0.18) var(--wipe-pos),
          transparent calc(var(--wipe-pos) + 15%)
        );
        mask-image: linear-gradient(to bottom, transparent 0%, transparent 90vh, black 100vh);
        -webkit-mask-image: linear-gradient(to bottom, transparent 0%, transparent 90vh, black 100vh);
        animation: wipe-sweep 0.55s ease-out forwards;
      }
      #theme-sweep.sweep-to-light {
        background: linear-gradient(
          105deg,
          rgba(255, 245, 220, 0.08) var(--wipe-pos),
          transparent calc(var(--wipe-pos) + 20%)
        );
        mask-image: linear-gradient(to bottom, transparent 0%, transparent 90vh, black 100vh);
        -webkit-mask-image: linear-gradient(to bottom, transparent 0%, transparent 90vh, black 100vh);
        animation: wipe-sweep 0.55s ease-out forwards;
      }
      @keyframes wipe-sweep {
        from { --wipe-pos: -15%; }
        to { --wipe-pos: 115%; }
      }
      @media (prefers-reduced-motion: reduce) {
        #theme-sweep { display: none; }
      }
    </style>

    <ViewTransitions />
  </head>
  <body class="bg-surface text-primary font-sans text-base leading-relaxed overflow-x-hidden antialiased" style="transition:background-color 0.55s ease,color 0.55s ease">
    <!-- Skip navigation -->
    <a href="#main-content" class="skip-nav" style="position:fixed;top:-100%">
      <span data-lang="en">Skip to content</span>
      <span data-lang="bg">Към съдържанието</span>
    </a>

    <!-- Scroll progress bar -->
    <div id="scroll-progress"></div>

    <slot />

    <!-- Theme sweep overlay — directional wipe synced with celestial arc -->
    <div id="theme-sweep" aria-hidden="true"></div>

    <!-- Console greeting -->
    <script is:inline>
      console.log('%c Hey there, fellow developer!', 'font-size: 20px; font-weight: bold; color: #c8973e;');
      console.log('%c Curious about the code? Check out my GitHub: https://github.com/SpitOnYourFace', 'font-size: 14px; color: #7a6f60;');
      console.log('%c Built with Astro, Tailwind CSS & TypeScript', 'font-size: 12px; color: #b0a898;');
    </script>
  </body>
</html>
