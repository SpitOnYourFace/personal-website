---
const links = [
  { href: '#about', en: 'about', bg: 'за мен' },
  { href: '#skills', en: 'skills', bg: 'умения' },
  { href: '#projects', en: 'projects', bg: 'проекти' },
  { href: '#crypto', en: 'crypto', bg: 'крипто' },
  { href: '#contact', en: 'contact', bg: 'контакт' },
];
---

<nav
  id="main-nav"
  data-nav-theme="hero"
  class="nav-pill fixed left-1/2 -translate-x-1/2 z-50 transition-all duration-500 backdrop-blur-xl rounded-full border"
  role="navigation"
  aria-label="Main navigation"
  style="top: 12px"
>
  <div class="flex items-center justify-between h-11 px-5 md:px-6 gap-2">
    <!-- Brand -->
    <a href="#" class="nav-brand relative font-mono font-bold tracking-tight transition-colors duration-500 text-sm shrink-0">
      InternetCodeSolutions
    </a>

    <!-- Desktop nav -->
    <div class="hidden md:flex items-center gap-0.5">
      <ul class="flex items-center gap-0.5">
        {links.map((link) => (
          <li>
            <a
              href={link.href}
              class="nav-link relative px-3 py-1.5 text-xs font-mono lowercase tracking-wide transition-all duration-300"
              data-section={link.href.slice(1)}
            >
              <span data-lang="en">{link.en}</span>
              <span data-lang="bg">{link.bg}</span>
              <span class="nav-dot absolute bottom-0 left-1/2 -translate-x-1/2 w-1 h-1 rounded-full transition-all duration-300 opacity-0 scale-0"></span>
            </a>
          </li>
        ))}
      </ul>

      <!-- Divider -->
      <span class="nav-divider w-px h-4 mx-2"></span>

      <!-- Dark mode toggle -->
      <button
        id="theme-toggle"
        class="theme-switch"
        role="switch"
        aria-checked="false"
        aria-label="Toggle dark mode"
      >
        <span class="theme-switch-track">
          <span class="theme-switch-knob">
            <svg class="theme-switch-icon icon-sun hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
            <svg class="theme-switch-icon icon-moon" fill="currentColor" viewBox="0 0 24 24">
              <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" />
            </svg>
          </span>
        </span>
      </button>

      <!-- Language toggle -->
      <div class="flex items-center gap-0.5 ml-0.5 text-xs font-mono">
        <button data-set-lang="en" class="lang-btn lang-btn-en px-1.5 py-0.5 rounded-full transition-colors duration-300" aria-pressed="true">EN</button>
        <span class="lang-sep opacity-30">/</span>
        <button data-set-lang="bg" class="lang-btn lang-btn-bg px-1.5 py-0.5 rounded-full transition-colors duration-300" aria-pressed="false">BG</button>
      </div>
    </div>

    <!-- Mobile controls -->
    <div class="flex items-center gap-0.5 md:hidden">
      <button
        id="theme-toggle-mobile"
        class="theme-switch"
        role="switch"
        aria-checked="false"
        aria-label="Toggle dark mode"
      >
        <span class="theme-switch-track">
          <span class="theme-switch-knob">
            <svg class="theme-switch-icon icon-sun hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
            <svg class="theme-switch-icon icon-moon" fill="currentColor" viewBox="0 0 24 24">
              <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" />
            </svg>
          </span>
        </span>
      </button>
      <button
        id="mobile-toggle"
        class="nav-toggle p-1.5 rounded-full transition-colors duration-300"
        aria-label="Toggle menu"
        aria-expanded="false"
      >
        <svg id="menu-open" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
        <svg id="menu-close" class="w-4 h-4 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
  </div>
</nav>

<!-- Mobile dropdown panel (separate from pill so it can be wider) -->
<div
  id="mobile-menu"
  class="mobile-panel fixed left-4 right-4 z-40 md:hidden rounded-2xl border backdrop-blur-xl overflow-hidden"
  style="top: 64px"
>
  <ul class="px-4 py-3 space-y-0.5">
    {links.map((link) => (
      <li>
        <a
          href={link.href}
          class="mobile-link nav-link-mobile block px-4 py-2.5 text-sm font-mono lowercase tracking-wide rounded-xl transition-colors duration-300"
          data-section={link.href.slice(1)}
        >
          <span data-lang="en">{link.en}</span>
          <span data-lang="bg">{link.bg}</span>
        </a>
      </li>
    ))}
  </ul>
  <div class="flex justify-center gap-2 px-4 py-3 border-t">
    <button data-set-lang="en" class="lang-btn lang-btn-en px-3 py-1.5 text-xs font-mono font-semibold rounded-full transition-colors duration-300" aria-pressed="true">EN</button>
    <button data-set-lang="bg" class="lang-btn lang-btn-bg px-3 py-1.5 text-xs font-mono rounded-full transition-colors duration-300" aria-pressed="false">BG</button>
  </div>
</div>

<style>
  /* ===== Pill shape ===== */
  .nav-pill {
    width: auto;
    max-width: min(90vw, 56rem);
  }

  @media (max-width: 767px) {
    .nav-pill {
      left: 16px;
      right: 16px;
      transform: none;
      width: auto;
    }
  }

  /* ===== Auto-hide transition ===== */
  .nav-pill {
    transform: translateX(-50%) translateY(0);
    transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1),
                background 0.5s ease,
                border-color 0.5s ease,
                box-shadow 0.5s ease;
  }
  .nav-pill.nav-hidden {
    transform: translateX(-50%) translateY(calc(-100% - 20px));
  }

  @media (max-width: 767px) {
    .nav-pill {
      transform: translateY(0);
    }
    .nav-pill.nav-hidden {
      transform: translateY(calc(-100% - 20px));
    }
  }

  /* ===== Underline slide on hover/active ===== */
  .nav-link::after {
    content: '';
    position: absolute;
    bottom: 2px;
    left: 50%;
    width: 0;
    height: 2px;
    border-radius: 1px;
    background: currentColor;
    transition: width 0.3s ease, left 0.3s ease;
  }
  .nav-link:hover::after {
    width: 60%;
    left: 20%;
  }
  .nav-link.active::after {
    width: 70%;
    left: 15%;
  }

  /* Brand underline */
  .nav-brand::after {
    content: '';
    position: absolute;
    bottom: -4px;
    left: 50%;
    width: 0;
    height: 2px;
    border-radius: 1px;
    background: currentColor;
    transition: width 0.3s ease, left 0.3s ease;
  }
  .nav-brand.active::after {
    width: 90%;
    left: 5%;
  }

  /* Active dot */
  .nav-link.active .nav-dot {
    opacity: 1;
    transform: translateX(-50%) scale(1);
  }

  /* ===== Theme toggle switch ===== */
  .theme-switch {
    position: relative;
    cursor: pointer;
    padding: 0;
    border: none;
    background: none;
    display: flex;
    align-items: center;
    -webkit-tap-highlight-color: transparent;
  }

  .theme-switch-track {
    position: relative;
    width: 36px;
    height: 20px;
    border-radius: 999px;
    transition: background 0.3s ease, border-color 0.3s ease;
    display: flex;
    align-items: center;
  }

  .theme-switch-knob {
    position: absolute;
    left: 2px;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), background 0.3s ease;
  }

  .theme-switch[aria-checked="true"] .theme-switch-knob {
    transform: translateX(16px);
  }

  .theme-switch-icon {
    width: 10px;
    height: 10px;
  }

  /* ===== Hero theme (over starfield) ===== */
  [data-nav-theme="hero"].nav-pill {
    background: rgba(10, 10, 24, 0.6);
    border-color: rgba(200, 151, 62, 0.12);
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(200, 151, 62, 0.05) inset;
  }
  [data-nav-theme="hero"] .nav-brand { color: #c8973e; }
  [data-nav-theme="hero"] .nav-link { color: rgba(200, 151, 62, 0.55); }
  [data-nav-theme="hero"] .nav-link:hover { color: #c8973e; }
  [data-nav-theme="hero"] .nav-link::after { background: #c8973e; }
  [data-nav-theme="hero"] .nav-link .nav-dot { background: #c8973e; }
  [data-nav-theme="hero"] .nav-link.active { color: #c8973e; }
  [data-nav-theme="hero"] .nav-toggle { color: rgba(200, 151, 62, 0.6); }
  [data-nav-theme="hero"] .nav-toggle:hover { color: #c8973e; }
  [data-nav-theme="hero"] .theme-switch-track { background: rgba(200, 151, 62, 0.15); border: 1px solid rgba(200, 151, 62, 0.2); }
  [data-nav-theme="hero"] .theme-switch-knob { background: rgba(200, 151, 62, 0.9); }
  [data-nav-theme="hero"] .theme-switch-icon { color: #0c0c1d; }
  [data-nav-theme="hero"] .nav-divider { background: rgba(200, 151, 62, 0.15); }
  [data-nav-theme="hero"] .lang-sep { color: rgba(255, 255, 255, 0.15); }
  [data-nav-theme="hero"] .lang-btn[aria-pressed="true"] { color: #c8973e; font-weight: 600; }
  [data-nav-theme="hero"] .lang-btn[aria-pressed="false"] { color: rgba(255, 255, 255, 0.3); }

  /* Hero mobile panel */
  [data-nav-theme="hero"] ~ .mobile-panel {
    background: rgba(10, 10, 24, 0.85);
    border-color: rgba(200, 151, 62, 0.1);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
  }
  [data-nav-theme="hero"] ~ .mobile-panel .nav-link-mobile { color: rgba(200, 151, 62, 0.6); }
  [data-nav-theme="hero"] ~ .mobile-panel .nav-link-mobile:hover,
  [data-nav-theme="hero"] ~ .mobile-panel .nav-link-mobile.active { color: #c8973e; background: rgba(200, 151, 62, 0.08); }
  [data-nav-theme="hero"] ~ .mobile-panel .border-t { border-color: rgba(200, 151, 62, 0.08); }
  [data-nav-theme="hero"] ~ .mobile-panel .lang-btn[aria-pressed="true"] { color: #c8973e; font-weight: 600; }
  [data-nav-theme="hero"] ~ .mobile-panel .lang-btn[aria-pressed="false"] { color: rgba(255, 255, 255, 0.3); }

  /* ===== Page theme (glassy transparent for About & Skills) ===== */
  [data-nav-theme="page"].nav-pill {
    background: rgb(var(--color-surface) / 0.15);
    backdrop-filter: blur(16px) saturate(1.4);
    -webkit-backdrop-filter: blur(16px) saturate(1.4);
    border-color: rgb(var(--color-primary) / 0.1);
    box-shadow: 0 4px 24px rgb(var(--color-primary) / 0.04),
                0 0 0 1px rgb(var(--color-primary) / 0.06) inset;
  }
  :global(.dark) [data-nav-theme="page"].nav-pill {
    background: rgb(var(--color-surface) / 0.2);
    border-color: rgb(var(--color-primary) / 0.08);
  }
  [data-nav-theme="page"] .nav-brand { color: rgb(var(--color-accent)); }
  [data-nav-theme="page"] .nav-link { color: rgb(var(--color-primary-tertiary)); }
  [data-nav-theme="page"] .nav-link:hover { color: rgb(var(--color-primary)); }
  [data-nav-theme="page"] .nav-link::after { background: rgb(var(--color-accent)); }
  [data-nav-theme="page"] .nav-link .nav-dot { background: rgb(var(--color-accent)); }
  [data-nav-theme="page"] .nav-link.active { color: rgb(var(--color-accent)); }
  [data-nav-theme="page"] .nav-toggle { color: rgb(var(--color-primary-secondary)); }
  [data-nav-theme="page"] .nav-toggle:hover { color: rgb(var(--color-primary)); }
  [data-nav-theme="page"] .theme-switch-track { background: rgba(0, 0, 0, 0.12); border: 1px solid rgba(0, 0, 0, 0.2); }
  [data-nav-theme="page"] .theme-switch-knob { background: rgb(var(--color-primary)); box-shadow: 0 1px 4px rgba(0, 0, 0, 0.25); }
  [data-nav-theme="page"] .theme-switch-icon { color: rgb(var(--color-surface)); }
  :global(.dark) [data-nav-theme="page"] .theme-switch-track { background: rgba(255, 255, 255, 0.12); border: 1px solid rgba(255, 255, 255, 0.2); }
  :global(.dark) [data-nav-theme="page"] .theme-switch-knob { box-shadow: 0 1px 4px rgba(0, 0, 0, 0.4); }
  [data-nav-theme="page"] .nav-divider { background: rgb(var(--color-primary) / 0.1); }
  [data-nav-theme="page"] .lang-sep { color: rgb(var(--color-primary-tertiary)); }
  [data-nav-theme="page"] .lang-btn[aria-pressed="true"] { color: rgb(var(--color-primary)); font-weight: 600; }
  [data-nav-theme="page"] .lang-btn[aria-pressed="false"] { color: rgb(var(--color-primary-tertiary)); }

  /* Page mobile panel */
  [data-nav-theme="page"] ~ .mobile-panel {
    background: rgb(var(--color-surface) / 0.2);
    backdrop-filter: blur(20px) saturate(1.4);
    -webkit-backdrop-filter: blur(20px) saturate(1.4);
    border-color: rgb(var(--color-primary) / 0.08);
    box-shadow: 0 8px 32px rgb(var(--color-primary) / 0.06);
  }
  [data-nav-theme="page"] ~ .mobile-panel .nav-link-mobile { color: rgb(var(--color-primary-secondary)); }
  [data-nav-theme="page"] ~ .mobile-panel .nav-link-mobile:hover,
  [data-nav-theme="page"] ~ .mobile-panel .nav-link-mobile.active { color: rgb(var(--color-primary)); background: rgb(var(--color-primary) / 0.04); }
  [data-nav-theme="page"] ~ .mobile-panel .border-t { border-color: rgb(var(--color-primary) / 0.06); }
  [data-nav-theme="page"] ~ .mobile-panel .lang-btn[aria-pressed="true"] { color: rgb(var(--color-primary)); font-weight: 600; }
  [data-nav-theme="page"] ~ .mobile-panel .lang-btn[aria-pressed="false"] { color: rgb(var(--color-primary-tertiary)); }

  /* ===== Forest theme (green backdrop, light text) ===== */
  [data-nav-theme="forest"].nav-pill {
    background: rgba(20, 50, 30, 0.65);
    border-color: rgba(160, 200, 120, 0.12);
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.25),
                0 0 0 1px rgba(160, 200, 120, 0.05) inset;
  }
  [data-nav-theme="forest"] .nav-brand { color: rgba(220, 240, 210, 0.9); }
  [data-nav-theme="forest"] .nav-link { color: rgba(200, 220, 190, 0.5); }
  [data-nav-theme="forest"] .nav-link:hover { color: rgba(220, 240, 210, 0.9); }
  [data-nav-theme="forest"] .nav-link::after { background: rgba(200, 220, 120, 0.7); }
  [data-nav-theme="forest"] .nav-link .nav-dot { background: rgba(200, 220, 120, 0.7); }
  [data-nav-theme="forest"] .nav-link.active { color: rgba(220, 240, 210, 0.9); }
  [data-nav-theme="forest"] .nav-toggle { color: rgba(200, 220, 190, 0.6); }
  [data-nav-theme="forest"] .nav-toggle:hover { color: rgba(220, 240, 210, 0.9); }
  [data-nav-theme="forest"] .theme-switch-track { background: rgba(200, 220, 190, 0.15); border: 1px solid rgba(200, 220, 190, 0.25); }
  [data-nav-theme="forest"] .theme-switch-knob { background: rgba(220, 240, 210, 0.9); box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3); }
  [data-nav-theme="forest"] .theme-switch-icon { color: #1a3c24; }
  [data-nav-theme="forest"] .nav-divider { background: rgba(200, 220, 190, 0.15); }
  [data-nav-theme="forest"] .lang-sep { color: rgba(200, 220, 190, 0.2); }
  [data-nav-theme="forest"] .lang-btn[aria-pressed="true"] { color: rgba(220, 240, 210, 0.9); font-weight: 600; }
  [data-nav-theme="forest"] .lang-btn[aria-pressed="false"] { color: rgba(200, 220, 190, 0.35); }

  [data-nav-theme="forest"] ~ .mobile-panel {
    background: rgba(20, 50, 30, 0.85);
    border-color: rgba(160, 200, 120, 0.1);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.35);
  }
  [data-nav-theme="forest"] ~ .mobile-panel .nav-link-mobile { color: rgba(200, 220, 190, 0.6); }
  [data-nav-theme="forest"] ~ .mobile-panel .nav-link-mobile:hover,
  [data-nav-theme="forest"] ~ .mobile-panel .nav-link-mobile.active { color: rgba(220, 240, 210, 0.9); background: rgba(200, 220, 190, 0.08); }
  [data-nav-theme="forest"] ~ .mobile-panel .border-t { border-color: rgba(200, 220, 190, 0.08); }
  [data-nav-theme="forest"] ~ .mobile-panel .lang-btn[aria-pressed="true"] { color: rgba(220, 240, 210, 0.9); font-weight: 600; }
  [data-nav-theme="forest"] ~ .mobile-panel .lang-btn[aria-pressed="false"] { color: rgba(200, 220, 190, 0.35); }

  /* ===== Pond theme (cool water tones) ===== */
  [data-nav-theme="underground"].nav-pill {
    background: rgba(10, 30, 50, 0.7);
    border-color: rgba(100, 180, 220, 0.12);
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(100, 180, 220, 0.05) inset;
  }
  [data-nav-theme="underground"] .nav-brand { color: rgba(210, 235, 250, 0.9); }
  [data-nav-theme="underground"] .nav-link { color: rgba(160, 200, 225, 0.5); }
  [data-nav-theme="underground"] .nav-link:hover { color: rgba(210, 235, 250, 0.9); }
  [data-nav-theme="underground"] .nav-link::after { background: #c8973e; }
  [data-nav-theme="underground"] .nav-link .nav-dot { background: #c8973e; }
  [data-nav-theme="underground"] .nav-link.active { color: rgba(210, 235, 250, 0.9); }
  [data-nav-theme="underground"] .nav-toggle { color: rgba(160, 200, 225, 0.6); }
  [data-nav-theme="underground"] .nav-toggle:hover { color: rgba(210, 235, 250, 0.9); }
  [data-nav-theme="underground"] .theme-switch-track { background: rgba(100, 180, 220, 0.15); border: 1px solid rgba(100, 180, 220, 0.25); }
  [data-nav-theme="underground"] .theme-switch-knob { background: rgba(210, 235, 250, 0.9); box-shadow: 0 1px 4px rgba(0, 0, 0, 0.35); }
  [data-nav-theme="underground"] .theme-switch-icon { color: #0a1e32; }
  [data-nav-theme="underground"] .nav-divider { background: rgba(100, 180, 220, 0.15); }
  [data-nav-theme="underground"] .lang-sep { color: rgba(100, 180, 220, 0.2); }
  [data-nav-theme="underground"] .lang-btn[aria-pressed="true"] { color: rgba(210, 235, 250, 0.9); font-weight: 600; }
  [data-nav-theme="underground"] .lang-btn[aria-pressed="false"] { color: rgba(160, 200, 225, 0.35); }

  [data-nav-theme="underground"] ~ .mobile-panel {
    background: rgba(10, 30, 50, 0.88);
    border-color: rgba(100, 180, 220, 0.1);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
  }
  [data-nav-theme="underground"] ~ .mobile-panel .nav-link-mobile { color: rgba(160, 200, 225, 0.6); }
  [data-nav-theme="underground"] ~ .mobile-panel .nav-link-mobile:hover,
  [data-nav-theme="underground"] ~ .mobile-panel .nav-link-mobile.active { color: rgba(210, 235, 250, 0.9); background: rgba(100, 180, 220, 0.08); }
  [data-nav-theme="underground"] ~ .mobile-panel .border-t { border-color: rgba(100, 180, 220, 0.08); }
  [data-nav-theme="underground"] ~ .mobile-panel .lang-btn[aria-pressed="true"] { color: rgba(210, 235, 250, 0.9); font-weight: 600; }
  [data-nav-theme="underground"] ~ .mobile-panel .lang-btn[aria-pressed="false"] { color: rgba(160, 200, 225, 0.35); }

  /* ===== Mobile menu animation ===== */
  .mobile-panel {
    opacity: 0;
    transform: translateY(-8px);
    pointer-events: none;
    visibility: hidden;
    transition: opacity 0.25s cubic-bezier(0.4, 0, 0.2, 1),
                transform 0.25s cubic-bezier(0.4, 0, 0.2, 1),
                visibility 0.25s;
  }
  .mobile-panel.menu-open {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
    visibility: visible;
  }
</style>

<script>
  // ---- Language toggle ----
  (function () {
    function getLang(): string {
      return document.documentElement.dataset.lang || 'en';
    }

    function setLang(lang: string) {
      document.documentElement.lang = lang;
      document.documentElement.dataset.lang = lang;
      localStorage.setItem('lang', lang);
      document.querySelectorAll('.lang-btn').forEach((btn) => {
        const btnLang = (btn as HTMLElement).dataset.setLang;
        (btn as HTMLElement).setAttribute('aria-pressed', btnLang === lang ? 'true' : 'false');
      });
    }

    document.querySelectorAll('[data-set-lang]').forEach((btn) => {
      btn.addEventListener('click', () => {
        setLang((btn as HTMLElement).dataset.setLang!);
      });
    });

    const currentLang = getLang();
    document.querySelectorAll('.lang-btn').forEach((btn) => {
      const btnLang = (btn as HTMLElement).dataset.setLang;
      (btn as HTMLElement).setAttribute('aria-pressed', btnLang === currentLang ? 'true' : 'false');
    });
  })();

  // ---- Dark mode toggle ----
  (function () {
    function isDark(): boolean {
      return document.documentElement.classList.contains('dark');
    }

    function updateIcons() {
      const dark = isDark();
      document.querySelectorAll('.icon-sun').forEach(el => el.classList.toggle('hidden', !dark));
      document.querySelectorAll('.icon-moon').forEach(el => el.classList.toggle('hidden', dark));
      document.querySelectorAll('.theme-switch').forEach(el => {
        el.setAttribute('aria-checked', dark ? 'true' : 'false');
      });
    }

    let themeBusy = false;

    function toggleTheme() {
      if (themeBusy) return;
      themeBusy = true;

      const dark = isDark();
      const goingDark = !dark;

      const sun = document.querySelector('.sky-sun') as HTMLElement | null;
      const moon = document.querySelector('.sky-moon') as HTMLElement | null;
      const sweep = document.getElementById('theme-sweep') as HTMLElement | null;

      document.documentElement.classList.toggle('dark', goingDark);
      localStorage.setItem('theme', goingDark ? 'dark' : 'light');
      updateIcons();

      if (sun && moon) {
        sun.style.animation = 'none';
        moon.style.animation = 'none';
        sun.classList.remove('arc-exit-right', 'arc-enter-left');
        moon.classList.remove('arc-exit-right', 'arc-enter-left');
      }
      if (sweep) {
        sweep.style.animation = 'none';
        sweep.classList.remove('sweep-to-dark', 'sweep-to-light');
      }

      requestAnimationFrame(() => {
        if (sun && moon) {
          sun.style.animation = '';
          moon.style.animation = '';

          if (goingDark) {
            sun.classList.add('arc-exit-right');
            moon.classList.add('arc-enter-left');
          } else {
            moon.classList.add('arc-exit-right');
            sun.classList.add('arc-enter-left');
          }
        }

        if (sweep) {
          sweep.style.animation = '';
          sweep.classList.add(goingDark ? 'sweep-to-dark' : 'sweep-to-light');
        }

        setTimeout(() => {
          if (sun && moon) {
            sun.classList.remove('arc-exit-right', 'arc-enter-left');
            moon.classList.remove('arc-exit-right', 'arc-enter-left');
          }
          if (sweep) {
            sweep.classList.remove('sweep-to-dark', 'sweep-to-light');
          }
          themeBusy = false;
        }, 650);
      });
    }

    document.getElementById('theme-toggle')?.addEventListener('click', toggleTheme);
    document.getElementById('theme-toggle-mobile')?.addEventListener('click', toggleTheme);
    updateIcons();
  })();

  // ---- Mobile menu toggle ----
  const toggle = document.getElementById('mobile-toggle');
  const menu = document.getElementById('mobile-menu');
  const iconOpen = document.getElementById('menu-open');
  const iconClose = document.getElementById('menu-close');

  toggle?.addEventListener('click', () => {
    const isOpen = menu?.classList.contains('menu-open');
    menu?.classList.toggle('menu-open');
    iconOpen?.classList.toggle('hidden');
    iconClose?.classList.toggle('hidden');
    toggle.setAttribute('aria-expanded', String(!isOpen));
  });

  document.querySelectorAll('.mobile-link').forEach((link) => {
    link.addEventListener('click', () => {
      menu?.classList.remove('menu-open');
      iconOpen?.classList.remove('hidden');
      iconClose?.classList.add('hidden');
      toggle?.setAttribute('aria-expanded', 'false');
    });
  });

  // ---- Smooth scroll for anchor links ----
  document.querySelectorAll('a[href^="#"]').forEach((link) => {
    link.addEventListener('click', (e) => {
      const href = (link as HTMLAnchorElement).getAttribute('href');
      if (!href) return;
      e.preventDefault();
      if (href === '#') {
        window.scrollTo({ top: 0, behavior: 'smooth' });
        history.pushState(null, '', ' ');
      } else {
        const target = document.querySelector(href);
        if (target) {
          target.scrollIntoView({ behavior: 'smooth' });
          history.pushState(null, '', href);
        }
      }
    });
  });

  // Close mobile menu on resize to desktop
  window.addEventListener('resize', () => {
    if (window.innerWidth >= 768 && menu && menu.classList.contains('menu-open')) {
      menu.classList.remove('menu-open');
      iconOpen?.classList.remove('hidden');
      iconClose?.classList.add('hidden');
      toggle?.setAttribute('aria-expanded', 'false');
    }
  });

  // ---- Auto-hide on scroll + theme swap + active section ----
  // Optimized: uses cached offsets instead of getBoundingClientRect per frame
  (function () {
    const nav = document.getElementById('main-nav');
    const hero = document.getElementById('hero');
    if (!nav || !hero) return;

    let lastScrollY = window.scrollY;
    let delta = 0;
    const THRESHOLD = 50;
    let ticking = false;

    // Section elements for active tracking
    const sectionIds = ['about', 'skills', 'projects', 'crypto', 'contact'];
    const sections = sectionIds
      .map(id => document.getElementById(id))
      .filter(Boolean) as HTMLElement[];
    const navLinks = nav.querySelectorAll('.nav-link[data-section]');
    const mobileLinks = document.querySelectorAll('.nav-link-mobile[data-section]');

    // Layer elements for theme detection
    const forest = document.querySelector('.layer-forest') as HTMLElement | null;
    const forestTransition = document.querySelector('.layer-sky-to-forest') as HTMLElement | null;
    const underground = document.querySelector('.layer-pond') as HTMLElement | null;
    const underTransition = document.querySelector('.layer-forest-to-pond') as HTMLElement | null;

    // Cached offsets — no getBoundingClientRect during scroll
    let heroEnd = 0;
    let forestStart = 0;
    let forestEnd = 0;
    let pondStart = 0;
    let sectionOffsets: { id: string; top: number }[] = [];
    let prevTheme = '';
    let prevActiveId = '';

    function getAbsoluteTop(el: HTMLElement): number {
      return el.getBoundingClientRect().top + window.scrollY;
    }

    function cacheOffsets() {
      heroEnd = getAbsoluteTop(hero!) + hero!.offsetHeight;
      const fEl = forestTransition || forest;
      const fEndEl = underTransition || underground;
      const pEl = underTransition || underground;
      forestStart = fEl ? getAbsoluteTop(fEl) : Infinity;
      forestEnd = fEndEl ? getAbsoluteTop(fEndEl) : Infinity;
      pondStart = pEl ? getAbsoluteTop(pEl) : Infinity;
      sectionOffsets = sections.map(s => ({ id: s.id, top: getAbsoluteTop(s) }));
    }

    cacheOffsets();
    window.addEventListener('resize', cacheOffsets, { passive: true });

    function update() {
      const scrollY = window.scrollY;
      const navOffset = 60;

      // Theme detection — pure math, zero layout queries
      let theme: string;
      const scrollCheck = scrollY + navOffset;
      if (scrollY + navOffset < heroEnd) {
        theme = 'hero';
      } else if (scrollCheck >= forestStart && scrollCheck < forestEnd) {
        theme = 'forest';
      } else if (scrollCheck >= pondStart) {
        theme = 'underground';
      } else {
        theme = 'page';
      }

      // Active section — pure math
      let activeId = '';
      for (let i = sectionOffsets.length - 1; i >= 0; i--) {
        if (scrollY + 120 >= sectionOffsets[i].top) {
          activeId = sectionOffsets[i].id;
          break;
        }
      }

      // === ALL WRITES BELOW — no layout thrashing ===

      // Theme swap (only on change)
      if (theme !== prevTheme) {
        nav!.dataset.navTheme = theme;
        prevTheme = theme;
      }

      // Auto-hide (only after scrolling past hero)
      if (theme !== 'hero') {
        const diff = scrollY - lastScrollY;
        delta += diff;
        if (delta > THRESHOLD) {
          nav!.classList.add('nav-hidden');
          if (menu && menu.classList.contains('menu-open')) {
            menu.classList.remove('menu-open');
            iconOpen?.classList.remove('hidden');
            iconClose?.classList.add('hidden');
            toggle?.setAttribute('aria-expanded', 'false');
          }
          delta = 0;
        } else if (delta < -THRESHOLD) {
          nav!.classList.remove('nav-hidden');
          delta = 0;
        }
      } else {
        nav!.classList.remove('nav-hidden');
        delta = 0;
      }

      lastScrollY = scrollY;

      // Active link highlights (only on change)
      if (activeId !== prevActiveId) {
        const brand = nav!.querySelector('.nav-brand');
        if (brand) brand.classList.toggle('active', activeId === '');
        navLinks.forEach((link) => {
          link.classList.toggle('active', (link as HTMLElement).dataset.section === activeId);
        });
        mobileLinks.forEach((link) => {
          link.classList.toggle('active', (link as HTMLElement).dataset.section === activeId);
        });
        prevActiveId = activeId;
      }

      ticking = false;
    }

    window.addEventListener('scroll', () => {
      if (!ticking) {
        ticking = true;
        requestAnimationFrame(update);
      }
    }, { passive: true });

    update();
  })();
</script>
